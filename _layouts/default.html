<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>{{ site.name }} - {{ page.title }}</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="{{ site.baseurl }}css/syntax.css">
        <!-- Custom CSS -->
        <link rel="stylesheet" href="{{ site.baseurl }}css/main.css">

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.3.1/jquery.cookie.min.js"></script>
        <script src="{{ site.baseurl }}js/menu.js"></script>

        <script type="text/javascript">
          var i = 0;

          function closeHierarchy() {
            var element = $(this);
            var id = element.attr('id');

            if (element.is(':checked'))
            {
              var papa = element.closest('li');
              var fils = papa.children('ul');
              $.cookie(id, 'true', { path: '/' });

              fils.find('input[type="checkbox"]').each(function(index, value){
                $(value).prop('checked', false);
                var localid = $(value).attr('id');
                $.removeCookie(localid, { path: '/' });
              });
            }
            else{
              $.removeCookie(id, { path: '/' });
            }
          }

          function process(arr, ul) {
            $.each(arr, function (index, value) {
              //check
              if(value.closed)
              {
                if(!value.children)
                  throw new Error("A closed information are present on sheet. It's not a valid configuration");

                if(value.closed != true)
                  throw new Error("The value expected in the closed information is 'true'");
              }

              var li = $("<li></li>");

              if (value.url) {
                var a = $('<a></a>');
                a.attr('href', '{{ site.baseurl }}' + value.url);
                a.text(value.title);

                li.append(a);
              } else {
                li.append(value.title);
              }

              if(value.closed == true)
              {
                var id = "check-" + i++;
                var checkbox = $('<input type="checkbox" class="checkbox" />');
                checkbox.click(closeHierarchy);
                checkbox.attr("id", id);
                if($.cookie(id))
                {
                  checkbox.prop('checked', true);
                }
                li.append(checkbox);

                var label = $('<label></label>');
                label.attr("for", id);
                li.append(label)
              }

              ul.append(li);

              if (value.children) {
                var inner_ul = $('<ul></ul>');
                li.append(inner_ul);
                process(value.children, inner_ul);
              }
            });
          }

          $(function() {

            // Generated On
            var generatedOn = moment('{{ site.time }}').fromNow();
            $('#generatedOn').text(generatedOn);

            // Menu Generation
            var list = $('#menuItems');
            var items = get_menu_definition()
            process(items, list);

          });
        </script>
    </head>
    <body>
        <div class="container">
          <div class="site">
            <div class="header">
              <div class="navigation">
                <div class="title"><a href="{{ site.baseurl }}">{{ site.name }}</a></div>
                <div class="github"><a href="{{ site.githuburl }}">View it on GitHub</a></div>
              </div>
            </div>
            <div class="core">
              <div class="menu test">
                <div>
                  <ul id="menuItems"/>
                </div>
              </div>
              <div class="content test">
                <div>
                  {{ content }}
                </div>
              </div>
            </div>
            <div class="footer test">
              <div style="text-align:center">Generated <span id="generatedOn" title="{{ site.time }}">{{ site.time }}</span></div>
            </div>
          </div>
        </div>
    </body>
</html>
